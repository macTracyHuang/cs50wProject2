const startmines=99;var mines,gameover,board,time,downid,room,sid,checked=0,first=!0,timerid=[],sync=!1;localStorage.getItem("username")||console.log("no name");const username=localStorage.getItem("username");function startTime(){stopTime(),timerid.push(setInterval(myTimer,1e3))}function stopTime(){console.log("stoptime");for(let e in timerid)clearInterval(timerid);timerid=[]}function myTimer(){(time+=1)<=999&&updateTime()}function getRandomid(e){for(var o="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=t.length,l=0;l<e;l++)o+=t.charAt(Math.floor(Math.random()*s));return o}var socket=io.connect(location.protocol+"//"+document.domain+":"+location.port+"/game",{query:"username="+username});socket.on("connect",()=>{room=socket.id,sid=socket.id}),socket.on("error",e=>{alert(e)}),document.querySelector("#invite").onclick=function(){sync&&(this.innerHTML="Sync:off",$("#invite").attr("disabled",!0),console.log("cancel sync send"),socket.emit("cancel sync",{fromUser:username,roomid:room}),sync=!1)},document.addEventListener("DOMContentLoaded",function(){socket.on("update client",e=>{const o=e.users,t=Handlebars.compile(document.querySelector("#aClient").innerHTML);document.querySelector("#clientList").innerHTML="";for(let e of o){const o=t({client_name:e});document.querySelector("#clientList").innerHTML+=o,setPopover(e)}console.log("update client")}),socket.on("new open",e=>{console.log("socket: newopen: "+e.cell.id+" from: "+e.username);const o=e.cell;board.cells[o.id].opened||opencell(o.id)}),socket.on("new flag",e=>{const o=e.cell;let t=document.querySelector("#"+o.id);console.log("socket: newflag: "+e.cell.id+" from: "+e.username),flagcell(t)}),socket.on("update board",e=>{if(console.log("update board received"),checked=0,mines=startmines,first=!0,gameover=!1,time=0,updateTime(),stopTime(),sync){console.log("socket: newboard: "+e.board.xSize+" from: "+e.username);e.username;const o=e.board;document.querySelectorAll(".cell").forEach((e,o)=>{e.className="",e.classList.add("cell","closed")}),board=o;let t=document.querySelector("#top_area_face");t.className="",t.classList.add("top-area-face","top-area-face-unpressed")}}),socket.on("update sync",e=>{let o=e.sync,t=document.querySelector("#invite");sync=o,console.log(o),sync?($("#invite").attr("disabled",!1),t.innerHTML="Cancel Sync",console.log("sync receive")):($("#invite").attr("disabled",!0),t.innerHTML="Sync:off",console.log("cancel sync receive")),t.classList.toggle("sync")}),socket.on("update roomid",e=>{console.log("try update roomid toUser: "+e.toUser),username===e.fromUser|username===e.toUser&&(console.log("updating: "+e.roomid+" socketid: "+socket.id),room="df"===e.roomid?socket.id:e.roomid)}),socket.on("new game",e=>{const o=e.fromUser,t=e.toUser;console.log("new game receive "+o),t===username&&(console.log("new game from "+o),$("#gameModal .modal-body").html(`${o} invites you to play a game.`),$("#gameModal").modal("show"))}),$("#gameModal #gameNo").click(function(){console.log(`reject game send from ${username}`),socket.emit("reject game",{roomid:room})}),$("#gameModal #gameYes").click(function(){console.log(`accept game send form ${username}`),sync=!0;let e=document.querySelector("#invite");sync&&(restart(),$("#invite").attr("disabled",!1),e.innerHTML="Cancel Sync"),e.classList.toggle("sync"),socket.emit("accept game",{board:board,roomid:room}),$("#gameModal").modal("hide"),console.log("play game together!")}),socket.on("yes game",e=>{username===e.toUser|username===e.fromUser&&(console.log("accept game"),alert(`${e.fromUser} accepts your invitation`))}),socket.on("no game",e=>{username===e.toUser&&(console.info(e.fromUser+": no game"),alert(`${e.fromUser} rejects your invitation`))}),socket.on("update score",e=>{document.querySelector("#best_score").innerHTML=`World Best Score: ${e.bestScore} by ${e.bestUser}`}),initBoard(),$("#btn-chat").attr("hidden",!1),$("#invite").attr("disabled",!0)});class Cell{constructor(e,o,t,s,l,c){this.id="cell_"+e+"_"+o,this.x=e,this.y=o,this.opened=t,this.flagged=s,this.mined=l,this.neighbor=c}get cell(){}cellMethod(){}toString(){return`Cell ${this.id},x:${this.x},y:${this.y},opened:${this.opened},flagged:${this.flagged},mined:${this.mined},neighbor:${this.neighbor}`}}class Board{constructor(e,o,t){this.cells={},this.xSize=e,this.ySize=o,this.mineCount=t;for(let e=0;e<this.xSize;e++)for(let o=0;o<this.ySize;o++)this.cells["cell_"+e+"_"+o]=new Cell(e,o,!1,!1,!1,0);Board.randomlyAssignMines(this),Board.calculateNeighborMineCounts(this)}toString(){return`Board ${this.cells},xSize:${this.xSize},ySize:${this.ySize},mineCount:${this.mineCount}`}static randomlyAssignMines(e){var o=[];for(let s=0;s<e.mineCount;s++){let s=t();for(;o.includes(s);)s=t();o.push(s),e.cells[s].neighbor=10,e.cells[s].mined=!0}return e;function t(){return"cell_"+Math.floor(Math.random()*e.xSize)+"_"+Math.floor(Math.random()*e.ySize)}}static calculateNeighborMineCounts(e){let o=e.cells,t=e.xSize,s=e.ySize;for(let e in o){let l=0;if(!o[e].mined){let c=getNeighbors(o[e],t,s);for(let e of c)l+=o[e].mined?1:0;o[e].neighbor=l}}}}function getNeighbors(e,o,t){var s=[];let l=e.x,c=e.y;return 0!==l&&(0!==c&&s.push("cell_"+(l-1)+"_"+(c-1)),s.push("cell_"+(l-1)+"_"+c),c!==t-1&&s.push("cell_"+(l-1)+"_"+(c+1))),0!==c&&s.push("cell_"+l+"_"+(c-1)),c!==t-1&&s.push("cell_"+l+"_"+(c+1)),l!==o-1&&(0!==c&&s.push("cell_"+(l+1)+"_"+(c-1)),s.push("cell_"+(l+1)+"_"+c),c!==t-1&&s.push("cell_"+(l+1)+"_"+(c+1))),s}function initBoard(){const e=Handlebars.compile(document.querySelector("#aCell").innerHTML),o=new Board(30,16,startmines);first=!0,gameover=!1,mines=startmines,board=o,time=0,stopTime(),updateMines(),document.querySelector("#A4").innerHTML="";for(let t=0;t<o.ySize;t++){for(let s=0;s<o.xSize;s++){const o=e({cell_id:"cell_"+s+"_"+t,cell_x:s,cell_y:t});document.querySelector("#A4").innerHTML+=o}const s='<div class="clear"></div>';document.querySelector("#A4").innerHTML+=s}var t=!1;document.querySelectorAll(".cell").forEach(e=>{const o=e.id;e.addEventListener("mousedown",e=>{if(first&&(startTime(),first=!1),!gameover&&0===e.button&&!board.cells[o].flagged)if(downid=o,t=!0,board.cells[o].opened){const e=getNeighbors(board.cells[o],30,16);for(let o of e){let e=document.querySelector("#"+o);e.classList.contains("closed")&&!e.classList.contains("flag")&&(e.classList.remove("closed"),e.classList.add("check"))}}else document.querySelector("#"+o).classList.remove("closed"),document.querySelector("#"+o).classList.add("check")}),e.addEventListener("mouseover",e=>{if(t&&downid!==o&&0===e.button){if(board.cells[downid].opened){const e=getNeighbors(board.cells[downid],30,16);for(let o of e){let e=document.querySelector("#"+o);e.classList.contains("check")&&!e.classList.contains("flag")&&(e.classList.toggle("closed"),e.classList.toggle("check"))}}else document.querySelector("#"+downid).classList.toggle("closed"),document.querySelector("#"+downid).classList.toggle("check");if(board.cells[o].opened){const e=getNeighbors(board.cells[o],30,16);for(let o of e){let e=document.querySelector("#"+o);e.classList.contains("closed")&&!e.classList.contains("flag")&&(e.classList.toggle("closed"),e.classList.toggle("check"))}}else document.querySelector("#"+o).classList.toggle("closed"),document.querySelector("#"+o).classList.toggle("check");downid=o}}),e.addEventListener("mouseup",e=>{if(!gameover&&t&&0===e.button){const e=getNeighbors(board.cells[downid],30,16);for(let o of e){let e=document.querySelector("#"+o);board.cells[o].opened||e.classList.contains("flag")||(e.classList.add("closed"),e.classList.remove("check"))}}gameover||!t||board.cells[o].opened||0!==e.button||(opencell(o),sync&&socket.emit("open cell",{cell:board.cells[o],roomid:room})),t=!1}),e.addEventListener("dblclick",e=>{if(!gameover){const e=getNeighbors(board.cells[o],30,16);let t=0;for(let o of e)t+=board.cells[o].flagged?1:0;if(t===board.cells[o].neighbor)for(let t of e)board.cells[t].flagged||setTimeout(function(){downid=o,opencell(t),sync&&(socket.emit("open cell",{cell:board.cells[t],roomid:room}),console.log("double emit"))},3)}}),e.addEventListener("contextmenu",o=>{flagcell(e),sync&&socket.emit("flag cell",{cell:board.cells[e.id],roomid:room}),t=!1,o.preventDefault()})});let s=document.querySelector("#top_area_face");s.addEventListener("mousedown",e=>{0===e.button&&(s.classList.remove("top-area-face-unpressed"),s.classList.remove("top-area-face-lose"),s.classList.remove("top-area-face-win"),s.classList.toggle("top-area-face-pressed"))}),s.addEventListener("mouseup",e=>{0===e.button&&(s.classList.toggle("top-area-face-pressed"),s.classList.add("top-area-face-unpressed"),restart(),sync&&socket.emit("restart game",{board:board,roomid:room}))})}function opencell(e){if(!gameover&&!board.cells[e].opened){sync&&first&&(startTime(),first=!1);const o=document.querySelector("#"+e),t=getNeighbors(board.cells[e],30,16);let s=board.cells[e].neighbor;if(0===s)for(let o of t)board.cells[o].opened||setTimeout(function(){downid=e,opencell(o)},3);else 10===s&&(gameover=!0,document.querySelector("#top_area_face").classList.remove("top-area-face-unpressed"),document.querySelector("#top_area_face").classList.add("top-area-face-lose"),s=11);o.classList.remove("check"),o.classList.remove("flag"),o.classList.remove("closed"),o.classList.add("type"+s),checked++,console.log(checked),board.cells[e].opened=!0}if(isWined()){gameover=!0;let e=document.querySelector("#top_area_face");e.classList.remove("top-area-face-unpressed"),e.classList.add("top-area-face-win");let o=$("#user_score").attr("data-sc");console.log(o),time<o&&($("#user_score").attr("data-sc",time),$("#user_score").html(`Your Best Score: ${time}`),socket.emit("new score",{score:time,username:username})),console.log("win")}gameover&&(stopTime(),document.querySelectorAll(".cell").forEach(e=>{let o=board.cells[e.id].neighbor;board.cells[e.id].opened||(board.cells[e.id].flagged&&10!==o||10===o)&&(10!==o?(o=12,e.classList.remove("flag")):e.classList.remove("closed"),e.classList.add("type"+o),board.cells[e.id].opened=!0)}))}function flagcell(e){gameover||board.cells[e.id].opened||(e.classList.toggle("closed"),e.classList.toggle("flag"),e.classList.contains("flag")?(board.cells[e.id].flagged=!0,mines--):(board.cells[e.id].flagged=!1,mines++),updateMines())}function isWined(){return checked===board.xSize*board.ySize-startmines}function updateMines(){let e=mines,o=[];for(;e>0;)o.push(e%10),e=Math.floor(e/10);let t=void 0===o[2]?0:o[2],s=void 0===o[1]?0:o[1],l=void 0===o[0]?0:o[0];document.querySelector("#top_area_mines_100").className="",document.querySelector("#top_area_mines_100").classList.add("top-area-num","pull-left","top-area-num"+t),document.querySelector("#top_area_mines_10").className="",document.querySelector("#top_area_mines_10").classList.add("top-area-num","pull-left","top-area-num"+s),document.querySelector("#top_area_mines_1").className="",document.querySelector("#top_area_mines_1").classList.add("top-area-num","pull-left","top-area-num"+l)}function updateTime(){let e=time,o=[];for(;e>0;)o.push(e%10),e=Math.floor(e/10);let t=void 0===o[2]?0:o[2],s=void 0===o[1]?0:o[1],l=void 0===o[0]?0:o[0];document.querySelector("#top_area_time_100").className="",document.querySelector("#top_area_time_100").classList.add("top-area-num","pull-left","top-area-num"+t),document.querySelector("#top_area_time_10").className="",document.querySelector("#top_area_time_10").classList.add("top-area-num","pull-left","top-area-num"+s),document.querySelector("#top_area_time_1").className="",document.querySelector("#top_area_time_1").classList.add("top-area-num","pull-left","top-area-num"+l)}function restart(){let e=document.querySelector("#top_area_face");e.className="",e.classList.add("top-area-face","top-area-face-unpressed"),checked=0,mines=startmines,first=!0,gameover=!1,time=0,updateTime(),stopTime();for(let e=0;e<board.xSize;e++)for(let o=0;o<board.ySize;o++){let t="cell_"+e+"_"+o;board.cells[t].opened=!1,board.cells[t].flagged=!1,board.cells[t].mined=!1,board.cells[t].neighbor=0,document.querySelector("#"+t).className="",document.querySelector("#"+t).classList.add("cell","closed")}updateMines(),Board.randomlyAssignMines(board),Board.calculateNeighborMineCounts(board)}function setPopover(e){console.log(`setpopover ${e}`),"Admin"!==e&&(setTimeout(()=>{$("#pop_"+e).each(function(){$(this).popover({container:"body",html:!0,placement:"left",sanitize:!1,trigger:"focus",content:`<button type="button" class="btn btn-sm private_game popover-content" id="game_${e}">Play Game</button>\n        `})})},10),setTimeout(()=>{$("#pop_"+e).each(function(){$(this).on("shown.bs.popover",function(){document.querySelector(".private_game").onclick=function(){if(sync)alert("Cancel Sync before inviting others");else{const o=e;socket.emit("invite game",{toUser:o,fromUser:username,roomid:room}),console.log("invite game "+o)}}})})},20))}
