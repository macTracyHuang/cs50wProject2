const startmines=99;var mines,gameover,board,time,downid,timerid,checked=0,first=!0;function startTime(){timerid=setInterval(myTimer,1e3)}function stopTime(){clearInterval(timerid),updateTime()}function myTimer(){(time+=1)<=999&&updateTime()}document.addEventListener("DOMContentLoaded",function(){initBoard()});class Cell{constructor(e,t,o,s,l,a){this.id="cell_"+e+"_"+t,this.x=e,this.y=t,this.opened=o,this.flagged=s,this.mined=l,this.neighbor=a}get cell(){}cellMethod(){}toString(){return`Cell ${this.id},x:${this.x},y:${this.y},opened:${this.opened},flagged:${this.flagged},mined:${this.mined},neighbor:${this.neighbor}`}}class Board{constructor(e,t,o){this.cells={},this.xSize=e,this.ySize=t,this.mineCount=o;for(let e=0;e<this.xSize;e++)for(let t=0;t<this.ySize;t++)this.cells["cell_"+e+"_"+t]=new Cell(e,t,!1,!1,!1,0);Board.randomlyAssignMines(this),Board.calculateNeighborMineCounts(this)}toString(){return`Board ${this.cells},xSize:${this.xSize},ySize:${this.ySize},mineCount:${this.mineCount}`}static randomlyAssignMines(e){var t=[];for(let s=0;s<e.mineCount;s++){let s=o();for(;t.includes(s);)s=o();t.push(s),e.cells[s].neighbor=10,e.cells[s].mined=!0}return e;function o(){return"cell_"+Math.floor(Math.random()*e.xSize)+"_"+Math.floor(Math.random()*e.ySize)}}static calculateNeighborMineCounts(e){let t=e.cells,o=e.xSize,s=e.ySize;for(let e in t){let l=0;if(!t[e].mined){let a=getNeighbors(t[e],o,s);for(let e of a)l+=t[e].mined?1:0;t[e].neighbor=l}}}}function getNeighbors(e,t,o){var s=[];let l=e.x,a=e.y;return 0!==l&&(0!==a&&s.push("cell_"+(l-1)+"_"+(a-1)),s.push("cell_"+(l-1)+"_"+a),a!==o-1&&s.push("cell_"+(l-1)+"_"+(a+1))),0!==a&&s.push("cell_"+l+"_"+(a-1)),a!==o-1&&s.push("cell_"+l+"_"+(a+1)),l!==t-1&&(0!==a&&s.push("cell_"+(l+1)+"_"+(a-1)),s.push("cell_"+(l+1)+"_"+a),a!==o-1&&s.push("cell_"+(l+1)+"_"+(a+1))),s}function initBoard(){const e=Handlebars.compile(document.querySelector("#aCell").innerHTML),t=new Board(30,16,startmines);first=!0,gameover=!1,mines=startmines,board=t,time=0,stopTime(),updateMines(),document.querySelector("#A4").innerHTML="";for(let o=0;o<t.ySize;o++){for(let s=0;s<t.xSize;s++){const t=e({cell_id:"cell_"+s+"_"+o,cell_x:s,cell_y:o});document.querySelector("#A4").innerHTML+=t}const s='<div class="clear"></div>';document.querySelector("#A4").innerHTML+=s}var o=!1;document.querySelectorAll(".cell").forEach(e=>{const t=e.id;e.addEventListener("mousedown",e=>{if(first&&(startTime(),first=!1),!gameover&&0===e.button&&!board.cells[t].flagged)if(console.log(!board.cells[t].flagged),downid=t,o=!0,board.cells[t].opened){const e=getNeighbors(board.cells[t],30,16);for(let t of e){let e=document.querySelector("#"+t);e.classList.contains("closed")&&!e.classList.contains("flag")&&(e.classList.remove("closed"),e.classList.add("check"))}}else document.querySelector("#"+t).classList.remove("closed"),document.querySelector("#"+t).classList.add("check")}),e.addEventListener("mouseover",e=>{if(o&&downid!==t&&0===e.button){if(board.cells[downid].opened){const e=getNeighbors(board.cells[downid],30,16);for(let t of e){let e=document.querySelector("#"+t);e.classList.contains("check")&&!e.classList.contains("flag")&&(e.classList.toggle("closed"),e.classList.toggle("check"))}}else document.querySelector("#"+downid).classList.toggle("closed"),document.querySelector("#"+downid).classList.toggle("check");if(board.cells[t].opened){const e=getNeighbors(board.cells[t],30,16);for(let t of e){let e=document.querySelector("#"+t);e.classList.contains("closed")&&!e.classList.contains("flag")&&(e.classList.toggle("closed"),e.classList.toggle("check"))}}else document.querySelector("#"+t).classList.toggle("closed"),document.querySelector("#"+t).classList.toggle("check");downid=t}}),e.addEventListener("mouseup",e=>{if(!gameover&&o&&0===e.button){const e=getNeighbors(board.cells[downid],30,16);for(let t of e){let e=document.querySelector("#"+t);board.cells[t].opened||e.classList.contains("flag")||(e.classList.add("closed"),e.classList.remove("check"))}}gameover||!o||board.cells[t].opened||0!==e.button||opencell(t),o=!1}),e.addEventListener("dblclick",e=>{if(console.log("dbclick"),!gameover){const e=getNeighbors(board.cells[t],30,16);let o=0;for(let t of e)o+=board.cells[t].flagged?1:0;if(o===board.cells[t].neighbor)for(let o of e)board.cells[o].flagged||setTimeout(function(){downid=t,opencell(o)},3)}}),e.addEventListener("contextmenu",s=>{gameover||(board.cells[e.id].opened||(e.classList.toggle("closed"),e.classList.toggle("flag"),e.classList.contains("flag")?(board.cells[t].flagged=!0,mines--):(board.cells[t].flagged=!1,mines++),updateMines()),o=!1,s.preventDefault())})});let s=document.querySelector("#top_area_face");s.addEventListener("mousedown",e=>{0===e.button&&(s.classList.remove("top-area-face-unpressed"),s.classList.remove("top-area-face-lose"),s.classList.remove("top-area-face-win"),s.classList.toggle("top-area-face-pressed"))}),s.addEventListener("mouseup",e=>{if(0===e.button){s.classList.toggle("top-area-face-pressed"),s.classList.add("top-area-face-unpressed"),checked=0,mines=startmines,first=!0,gameover=!1,time=0,stopTime();for(let e=0;e<board.xSize;e++)for(let t=0;t<board.ySize;t++){let o="cell_"+e+"_"+t;board.cells[o].opened=!1,board.cells[o].flagged=!1,board.cells[o].mined=!1,board.cells[o].neighbor=0,document.querySelector("#"+o).className="",document.querySelector("#"+o).classList.add("cell","closed")}updateMines(),Board.randomlyAssignMines(board),Board.calculateNeighborMineCounts(board)}})}function opencell(e){if(!gameover&&!board.cells[e].opened){const t=document.querySelector("#"+e),o=getNeighbors(board.cells[e],30,16);let s=board.cells[e].neighbor;if(0===s)for(let t of o)board.cells[t].opened||setTimeout(function(){downid=e,opencell(t)},3);else 10===s&&(gameover=!0,document.querySelector("#top_area_face").classList.remove("top-area-face-unpressed"),document.querySelector("#top_area_face").classList.add("top-area-face-lose"),s=11);t.classList.remove("check"),t.classList.remove("flag"),t.classList.remove("closed"),t.classList.add("type"+s),checked++,board.cells[e].opened=!0}if(isWined()){gameover=!0;let e=document.querySelector("#top_area_face");e.classList.remove("top-area-face-unpressed"),e.classList.add("top-area-face-win"),console.log("win")}gameover&&(stopTime(),document.querySelectorAll(".cell").forEach(e=>{console.log(e.id);let t=board.cells[e.id].neighbor;board.cells[e.id].opened||(board.cells[e.id].flagged&&10!==t||10===t)&&(10!==t?(t=12,e.classList.remove("flag")):e.classList.remove("closed"),e.classList.add("type"+t),board.cells[e.id].opened=!0)}))}function isWined(){return checked===board.xSize*board.ySize-startmines}function updateMines(){let e=mines,t=[];for(;e>0;)t.push(e%10),e=Math.floor(e/10);let o=void 0===t[2]?0:t[2],s=void 0===t[1]?0:t[1],l=void 0===t[0]?0:t[0];document.querySelector("#top_area_mines_100").className="",document.querySelector("#top_area_mines_100").classList.add("top-area-num","pull-left","top-area-num"+o),document.querySelector("#top_area_mines_10").className="",document.querySelector("#top_area_mines_10").classList.add("top-area-num","pull-left","top-area-num"+s),document.querySelector("#top_area_mines_1").className="",document.querySelector("#top_area_mines_1").classList.add("top-area-num","pull-left","top-area-num"+l)}function updateTime(){let e=time,t=[];for(;e>0;)t.push(e%10),e=Math.floor(e/10);let o=void 0===t[2]?0:t[2],s=void 0===t[1]?0:t[1],l=void 0===t[0]?0:t[0];document.querySelector("#top_area_time_100").className="",document.querySelector("#top_area_time_100").classList.add("top-area-num","pull-left","top-area-num"+o),document.querySelector("#top_area_time_10").className="",document.querySelector("#top_area_time_10").classList.add("top-area-num","pull-left","top-area-num"+s),document.querySelector("#top_area_time_1").className="",document.querySelector("#top_area_time_1").classList.add("top-area-num","pull-left","top-area-num"+l)}