const startmines=99;var mines,gameover,board,time,downid,checked=0;document.addEventListener("DOMContentLoaded",function(){initBoard()});class Cell{constructor(e,o,t,s,l,c){this.id="cell_"+e+"_"+o,this.x=e,this.y=o,this.opened=t,this.flagged=s,this.mined=l,this.neighbor=c}get cell(){}cellMethod(){}toString(){return`Cell ${this.id},x:${this.x},y:${this.y},opened:${this.opened},flagged:${this.flagged},mined:${this.mined},neighbor:${this.neighbor}`}}class Board{constructor(e,o,t){this.cells={},this.xSize=e,this.ySize=o,this.mineCount=t;for(let e=0;e<this.xSize;e++)for(let o=0;o<this.ySize;o++)this.cells["cell_"+e+"_"+o]=new Cell(e,o,!1,!1,!1,0);Board.randomlyAssignMines(this),Board.calculateNeighborMineCounts(this)}toString(){return`Board ${this.cells},xSize:${this.xSize},ySize:${this.ySize},mineCount:${this.mineCount}`}static randomlyAssignMines(e){var o=[];for(let s=0;s<e.mineCount;s++){let s=t();for(;o.includes(s);)s=t();o.push(s),e.cells[s].neighbor=10,e.cells[s].mined=!0}return e;function t(){return"cell_"+Math.floor(Math.random()*e.xSize)+"_"+Math.floor(Math.random()*e.ySize)}}static calculateNeighborMineCounts(e){let o=e.cells,t=e.xSize,s=e.ySize;for(let e in o){let l=0;if(!o[e].mined){let c=getNeighbors(o[e],t,s);for(let e of c)l+=o[e].mined?1:0;o[e].neighbor=l}}}}function getNeighbors(e,o,t){var s=[];let l=e.x,c=e.y;return 0!==l&&(0!==c&&s.push("cell_"+(l-1)+"_"+(c-1)),s.push("cell_"+(l-1)+"_"+c),c!==t-1&&s.push("cell_"+(l-1)+"_"+(c+1))),0!==c&&s.push("cell_"+l+"_"+(c-1)),c!==t-1&&s.push("cell_"+l+"_"+(c+1)),l!==o-1&&(0!==c&&s.push("cell_"+(l+1)+"_"+(c-1)),s.push("cell_"+(l+1)+"_"+c),c!==t-1&&s.push("cell_"+(l+1)+"_"+(c+1))),s}function initBoard(){const e=Handlebars.compile(document.querySelector("#aCell").innerHTML),o=new Board(30,16,startmines);gameover=!1,mines=startmines,board=o,time=0,updateMines(),document.querySelector("#A4").innerHTML="";for(let t=0;t<o.ySize;t++){for(let s=0;s<o.xSize;s++){const o=e({cell_id:"cell_"+s+"_"+t,cell_x:s,cell_y:t});document.querySelector("#A4").innerHTML+=o}const s='<div class="clear"></div>';document.querySelector("#A4").innerHTML+=s}var t=!1;document.querySelectorAll(".cell").forEach(e=>{const o=e.id;e.addEventListener("mousedown",e=>{if(!gameover&&0===e.button)if(downid=o,t=!0,board.cells[o].opened){const e=getNeighbors(board.cells[o],30,16);for(let o of e){let e=document.querySelector("#"+o);e.classList.contains("closed")&&(e.classList.remove("closed"),e.classList.add("check"))}}else document.querySelector("#"+o).classList.remove("closed"),document.querySelector("#"+o).classList.add("check")}),e.addEventListener("mouseover",e=>{if(t&&downid!==o&&0===e.button){if(board.cells[downid].opened){const e=getNeighbors(board.cells[downid],30,16);for(let o of e){let e=document.querySelector("#"+o);e.classList.contains("check")&&(e.classList.toggle("closed"),e.classList.toggle("check"))}}else document.querySelector("#"+downid).classList.toggle("closed"),document.querySelector("#"+downid).classList.toggle("check");if(board.cells[o].opened){const e=getNeighbors(board.cells[o],30,16);for(let o of e){let e=document.querySelector("#"+o);e.classList.contains("closed")&&(e.classList.toggle("closed"),e.classList.toggle("check"))}}else document.querySelector("#"+o).classList.toggle("closed"),document.querySelector("#"+o).classList.toggle("check");downid=o}}),e.addEventListener("mouseup",e=>{if(!gameover&&t&&0===e.button){const e=getNeighbors(board.cells[downid],30,16);for(let o of e){let e=document.querySelector("#"+o);board.cells[o].opened||(e.classList.add("closed"),e.classList.remove("check"))}}t=!1,gameover||board.cells[o].opened||0!==e.button||opencell(o)}),e.addEventListener("dblclick",e=>{if(console.log("dbclick"),!gameover){const e=getNeighbors(board.cells[o],30,16);let t=0;for(let o of e)t+=board.cells[o].flagged?1:0;if(t===board.cells[o].neighbor)for(let t of e)board.cells[t].flagged||setTimeout(function(){downid=o,opencell(t)},3)}}),e.addEventListener("contextmenu",s=>{gameover||(board.cells[e.id].opened||(e.classList.toggle("closed"),e.classList.toggle("flag"),e.classList.contains("flag")?(board.cells[o].flagged=!0,mines--):(board.cells[o].flagged=!1,mines++),updateMines()),t=!1,s.preventDefault())})});let s=document.querySelector("#top_area_face");s.addEventListener("mousedown",e=>{0===e.button&&(s.classList.remove("top-area-face-unpressed"),s.classList.remove("top-area-face-lose"),s.classList.remove("top-area-face-win"),s.classList.toggle("top-area-face-pressed"))}),s.addEventListener("mouseup",e=>{if(0===e.button){s.classList.toggle("top-area-face-pressed"),s.classList.add("top-area-face-unpressed"),checked=0,mines=startmines,gameover=!1,time=0;for(let e=0;e<board.xSize;e++)for(let o=0;o<board.ySize;o++){let t="cell_"+e+"_"+o;board.cells[t].opened=!1,board.cells[t].flagged=!1,board.cells[t].mined=!1,board.cells[t].neighbor=0,document.querySelector("#"+t).className="",document.querySelector("#"+t).classList.add("cell","closed")}updateMines(),Board.randomlyAssignMines(board),Board.calculateNeighborMineCounts(board)}})}function opencell(e){if(!gameover&&!board.cells[e].opened){const o=document.querySelector("#"+e),t=getNeighbors(board.cells[e],30,16);let s=board.cells[e].neighbor;if(0===s)for(let o of t)board.cells[o].opened||setTimeout(function(){downid=e,opencell(o)},3);else 10===s&&(gameover=!0,document.querySelector("#top_area_face").classList.remove("top-area-face-unpressed"),document.querySelector("#top_area_face").classList.add("top-area-face-lose"),s=11);o.classList.remove("check"),o.classList.remove("closed"),o.classList.add("type"+s),checked++,board.cells[e].opened=!0}if(isWined()){gameover=!0;let e=document.querySelector("#top_area_face");e.classList.remove("top-area-face-unpressed"),e.classList.add("top-area-face-win"),console.log("win")}gameover&&(console.log("gameover"),document.querySelectorAll(".innercell").forEach(e=>{let o=board.innercells[e.id].neighbor;board.innercells[e.id].opened||(board.innercells[e.id].flagged&&10!==o||10===o)&&(10!==o&&(o=12),e.classList.remove("closed"),e.classList.remove("flag"),e.classList.add("type"+o),e.opened=!0)}))}function isWined(){return checked===board.xSize*board.ySize-startmines}function updateMines(){let e=mines,o=[];for(;e>0;)o.push(e%10),e=Math.floor(e/10);let t=void 0===o[2]?0:o[2],s=void 0===o[1]?0:o[1],l=void 0===o[0]?0:o[0];document.querySelector("#top_area_mines_100").className="",document.querySelector("#top_area_mines_100").classList.add("top-area-num","pull-left","top-area-num"+t),document.querySelector("#top_area_mines_10").className="",document.querySelector("#top_area_mines_10").classList.add("top-area-num","pull-left","top-area-num"+s),document.querySelector("#top_area_mines_1").className="",document.querySelector("#top_area_mines_1").classList.add("top-area-num","pull-left","top-area-num"+l)}